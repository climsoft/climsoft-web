<ng-container *ngIf="open && viewSource">
  <app-dialog [(open)]="open" [title]="title" [displayOkOption]="false" (cancelClick)="closeDialog()">

    <div class="card border-0">
      <div class="card-header d-flex px-1 py-0 flex-column">
        <div *ngIf="showStationSelection" class="mt-1">
          <app-station-selector-single [label]="'Station'" [includeOnlyIds]="onlyIncludeStationIds"
            [(selectedId)]="selectedStationId" />
        </div>
        <div class="mt-1 mb-1 d-flex justify-content-between align-items-center">
          <div>
            File to Upload
          </div>
          <div class="d-flex align-items-center" style="gap: 8px;">
            <input #fileUpload type="file" style="display: none;" [accept]="'.csv,.dat,.tsv,.txt'"
              (change)="onFileSelected($event)">
            <button type="button" class="btn btn-outline-secondary btn-sm" [disabled]="disableUpload"
              (click)="fileUpload.click()">
              Upload File
            </button>
          </div>
        </div>
      </div>

      <div class="card-body px-1">

        <!-- Status message -->
        <div *ngIf="importMessage" class="alert py-2 mb-2"
          [ngClass]="{ 'alert-danger': importStage === ImportStage.ERROR, 'alert-success': importStage === ImportStage.SUCCESS, 'alert-info': importStage === ImportStage.UPLOADING || importStage === ImportStage.PREVIEWING || importStage === ImportStage.IMPORTING }">
          <div class="d-flex align-items-center" style="gap: 8px;">
            <div
              *ngIf="importStage === ImportStage.UPLOADING || importStage === ImportStage.PREVIEWING || importStage === ImportStage.IMPORTING"
              class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            {{ importMessage }}
          </div>
        </div>

        <!-- Confirm / Cancel buttons (after successful preview) -->
        <div *ngIf="showConfirmImport" class="d-flex justify-content-end mb-2" style="gap: 8px;">
          <button type="button" class="btn btn-outline-secondary btn-sm" (click)="onCancelImport()">
            Cancel
          </button>
          <button type="button" class="btn btn-primary btn-sm" (click)="onConfirmImport()">
            Confirm Import
          </button>
        </div>

        <!-- Sample file preview -->
        <app-import-preview-table [title]="'Sample File (from specification)'" [columns]="sampleColumns"
          [rows]="sampleRows" [totalRowCount]="sampleTotalRowCount" [loading]="sampleLoading"
          [hasFile]="sampleHasFile"
          [noFileMessage]="'No sample file available for this import specification'" />

        <!-- Skipped rows from sample file -->
        <div *ngIf="sampleSkippedRows.length > 0" class="mt-2">
          <div class="mb-1 small text-muted">Skipped Rows ({{ sampleSkippedRows.length }})</div>
          <div class="table-responsive">
            <table class="table table-sm table-bordered mb-0">
              <tbody>
                <tr *ngFor="let row of sampleSkippedRows">
                  <td *ngFor="let cell of row" class="text-nowrap small text-muted">{{ cell }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Raw upload file preview (before transformation) -->
        <div class="mt-3">
          <app-import-preview-table [title]="'Uploaded File Preview (Raw)'" [columns]="rawUploadColumns"
            [rows]="rawUploadRows" [totalRowCount]="rawUploadTotalRowCount" [hasFile]="rawUploadHasFile"
            [noFileMessage]="'Upload a file to see the raw data'" />
        </div>

        <!-- Upload file preview (transformed data) -->
        <div class="mt-3">
          <app-import-preview-table [title]="'Uploaded File Preview (Transformed)'" [columns]="uploadColumns"
            [rows]="uploadRows" [totalRowCount]="uploadTotalRowCount" [rowsDropped]="uploadRowsDropped"
            [warnings]="uploadWarnings" [error]="uploadError" [loading]="uploadLoading" [hasFile]="uploadHasFile"
            [noFileMessage]="'Upload a file to see a preview of the transformed data before importing'" />
        </div>

      </div>
    </div>

  </app-dialog>
</ng-container>
