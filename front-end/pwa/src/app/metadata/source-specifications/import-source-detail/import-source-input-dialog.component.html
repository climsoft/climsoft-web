<ng-container *ngIf="open && importSource">
    <app-dialog [(open)]="open" [title]="title" [okButtonLabel]="'Save'" [displayDeleteOption]="importSource.id > 0"
        [closeOnOkClick]="false" [closeOnDeleteClick]="false" (okClick)="onSave()" (deleteClick)="onDelete()"
        (cancelClick)="closeDialog()">

        <!-- Wizard Tab Navigation -->
        <div class="mb-3">
            <ul class="nav nav-tabs">
                <li class="nav-item" *ngFor="let step of wizardSteps">
                    <button class="nav-link" [class.active]="activeStep === step"
                        [class.disabled]="isStepDisabled(step)" (click)="onStepTabClick(step)">
                        {{ stepLabels[step] }}
                    </button>
                </li>
            </ul>
        </div>

        <div class="row">

            <!-- Left column: Step configuration controls -->
            <div class="col-md-5 d-flex flex-column justify-content-between gap-3">

                <div>
                    <!-- Step: File & Basics -->
                    <div *ngIf="activeStep === 'upload'">
                        <div class="mb-3">
                            <app-file-input [label]="'Sample File'" [buttonLabel]="'Upload Sample File'"
                                [fileName]="uploadedFileName" (fileSelected)="onFileSelected($event)" />
                        </div>
                        
                        <hr />
                        
                        <div>
                            <app-text-input [label]="'Name'" [(value)]="importSource.name" />
                        </div>
                        
                        <hr />

                        <div>
                            <app-text-input [label]="'Description'" [(value)]="importSource.description" />
                        </div>

                        <hr />

                        <div>
                            <app-number-input [label]="'Rows to Skip'" [(numValue)]="tabularImportParams.rowsToSkip" />
                        </div>
                        
                        <hr />

                        <div>
                            <app-import-source-delimeter-detail [(delimiter)]="tabularImportParams.delimiter" />
                        </div>


                    </div>

                    <!-- Step: Station -->
                    <div *ngIf="activeStep === 'station'">
                        <app-import-source-station-detail
                            [(stationDefinition)]="tabularImportParams.stationDefinition" />
                    </div>

                    <!-- Step: Elements -->
                    <div *ngIf="activeStep === 'element'">
                        <app-import-source-element-detail [elementDefinition]="tabularImportParams.elementDefinition"
                            (elementDefinitionChange)="onElementOrDatetimeDefChanged()" />
                    </div>

                    <!-- Step: Date & Time -->
                    <div *ngIf="activeStep === 'datetime'">
                        <app-import-source-date-detail [datetimeDefinition]="tabularImportParams.datetimeDefinition"
                            (datetimeDefinitionChange)="onElementOrDatetimeDefChanged()" />
                    </div>

                    <!-- Step: Value & More -->
                    <div *ngIf="activeStep === 'value'">
                        <div class="mb-3">
                            <app-import-source-value-detail [(valueDefinition)]="tabularImportParams.valueDefinition" />
                        </div>

                        <hr />

                        <div class="mb-3">
                            <app-import-source-interval-detail
                                [intervalDefinition]="tabularImportParams.intervalDefinition" />
                        </div>

                        <hr />

                        <div class="mb-3">
                            <app-import-source-level-detail
                                [(levelColumnPosition)]="tabularImportParams.levelColumnPosition" />
                        </div>

                        <hr />

                        <div class="mb-3">
                            <app-number-input [label]="'UTC Offset'" [(numValue)]="importSource.utcOffset" />
                        </div>

                        <hr />

                        <div class="mb-3">
                            <app-import-source-missing-flag-detail
                                [(allowMissingValue)]="importSource.allowMissingValue"
                                [(sourceMissingValueFlags)]="importSourceParams.sourceMissingValueFlags" />
                        </div>

                        <hr />

                        <div class="mb-3">
                            <app-check-box-input [label]="'Scale Values (e.g 101 to 10.1)'"
                                [(value)]="importSource.scaleValues" />
                        </div>
                    </div>

                    <!-- Step: Review -->
                    <div *ngIf="activeStep === 'review'">
                        <h6>Configuration Summary</h6>

                        <div class="mb-2">
                            <strong>Name:</strong> {{ importSource.name }}
                        </div>
                        <div class="mb-2">
                            <strong>Description:</strong> {{ importSource.description }}
                        </div>
                        <div class="mb-2">
                            <strong>Rows to Skip:</strong> {{ tabularImportParams.rowsToSkip }}
                        </div>
                        <div class="mb-2">
                            <strong>Delimiter:</strong> {{ tabularImportParams.delimiter || 'Auto-detect' }}
                        </div>
                        <div class="mb-2">
                            <strong>Station:</strong>
                            {{ tabularImportParams.stationDefinition ? 'Column ' +
                            tabularImportParams.stationDefinition.columnPosition : 'Provided at import time' }}
                        </div>
                        <div class="mb-2">
                            <strong>UTC Offset:</strong> {{ importSource.utcOffset }}
                        </div>
                        <div class="mb-2">
                            <strong>Allow Missing Values:</strong> {{ importSource.allowMissingValue ? 'Yes' : 'No' }}
                        </div>
                        <div class="mb-2">
                            <strong>Scale Values:</strong> {{ importSource.scaleValues ? 'Yes' : 'No' }}
                        </div>

                        <hr />

                        <div class="mb-3">
                            <app-check-box-input [label]="'Disable'" [(value)]="importSource.disabled" />
                        </div>

                        <div class="mb-3">
                            <app-text-input [label]="'Comment'" [(value)]="importSource.comment" />
                        </div>

                        <div *ngIf="errorMessage" class="alert alert-danger py-2">
                            {{ errorMessage }}
                        </div>
                    </div>
                </div>


                <!-- Refresh and Navigation buttons. Only show them when the preview session has been set up. -->
                <div *ngIf="sessionId" class="d-flex justify-content-end gap-1 mt-3 pt-3 border-top">
                    <button *ngIf="activeStep !== 'upload'" class="btn btn-sm btn-outline-secondary"
                        (click)="onPrevious()">
                        Previous
                    </button>

                    <button *ngIf="activeStep !== 'review'" class="btn btn-sm btn-outline-primary" (click)="onNext()">
                        Next
                    </button>
                </div>

            </div>

            <!-- Right column: Preview tables -->
            <div class="col-md-7">
                <div class="d-flex justify-content-end mb-2">
                    <button type="button" class="btn btn-outline-info btn-sm" (click)="refreshPreview()">
                        Refresh Preview
                    </button>
                </div>

                <div *ngIf="skippedRows.length > 0" class="mb-3">
                    <app-import-preview-table [title]="'Skipped Rows'" [columns]="previewColumns" [rows]="skippedRows"
                        [hasFile]="true" />
                </div>

                <app-import-preview-table [title]="'Data Preview'" [columns]="previewColumns" [rows]="previewRows"
                    [totalRowCount]="totalRowCount" [rowsDropped]="rowsDropped" [warnings]="warnings" [error]="error"
                    [loading]="previewLoading" [hasFile]="!!sessionId"
                    [noFileMessage]="'Upload a sample file on the left to see a live preview of how your data will be processed'" />
            </div>

        </div>

    </app-dialog>

    <app-delete-confirmation-dialog #dlgDeleteConfirm [itemName]="importSource.name" [itemType]="'import specification'"
        (deleteConfirmed)="onDeleteConfirm()" />
</ng-container>